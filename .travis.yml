# This .travis.yml file was autogenerated from github.com/ericdill/travis-little-helper/template.py.
# Please do not edit this by hand!

language: python

sudo: false

services:
  - mongodb

matrix:
  include:
  # ophyd is python 3+ only... https://github.com/NSLS-II/ophyd/blob/master/ophyd/controls/positioner.py#L207
#  - python: 2.7
  - python: 3.4
  - python: 3.5

before_install:
  - perl --version
  - env
  # `git describe` failed a couple of times if I don't `git fetch --unshallow`
  - git fetch --unshallow
  # INSTALL CONDA
  - wget https://repo.continuum.io/miniconda/Miniconda3-latest-Linux-x86_64.sh -O miniconda.sh
  - chmod +x miniconda.sh
  - "./miniconda.sh -b -p /home/travis/mc"
  - export PATH=/home/travis/mc/bin:$PATH
  - conda config --set always_yes true
  - conda update conda --yes
  - conda install conda-build anaconda-client jinja2
  - conda config --add channels lightsource2

  # CONFIGURE USEFUL ENVIRONMENTAL VARIABLES
  - export OWNER_NAME=$(IFS="/"; arr=($TRAVIS_REPO_SLUG); echo ${arr[0]})
  - export REPO_NAME=$(IFS="/"; arr=($TRAVIS_REPO_SLUG); echo ${arr[1]})
  - export CONDA_BUILD_COMMAND="conda build conda-recipe --python=$TRAVIS_PYTHON_VERSION"
  - export GIT_FULL_HASH=`git rev-parse HEAD`
  # SOME DEBUG OUTPUT
  - echo "OWNER_NAME=$OWNER_NAME"
  - echo "REPO_NAME=$REPO_NAME"
  - echo "TRAVIS_COMMIT=$TRAVIS_COMMIT"
  - git describe
  # MAKE THE CONDA RECIPE
  - git clone https://github.com/ericdill/travis-little-helper ../travis-little-helper
  - conda create -n testenv python=$TRAVIS_PYTHON_VERSION
  - source activate testenv
  - conda install -c ericdill depfinder
  - wget https://raw.githubusercontent.com/ericdill/conda-skeletor-configs/master/ophyd/conda-skeletor.yml
  - pip install https://github.com/ericdill/conda-skeletor/zipball/master#egg=conda_skeletor
  - conda skeletor -p . -o conda-recipe

  # INSTALL DEPS REQUIRED FOR MOTOR IOC
  - conda install -n testenv -c klauer epics-synapps
  - conda install -n testenv -c lightsource2 ncurses
  # need to reactivate after installing epics-base so that the EPICS_BASE env
  # var is set
  - source activate testenv

install:
  # INSTALL OPHYD
  - python ../travis-little-helper/list_test_deps.py -p conda-recipe/meta.yaml
  - conda install `python ../travis-little-helper/list_test_deps.py -p conda-recipe/meta.yaml`
  - python setup.py install
  # INSTALL THE MOTOR IOC
  - ldd --version
  - env
  - cd ..
  - git clone https://github.com/dchabot/motorsim
  - cd motorsim
  - echo "TEMPLATE_TOP=\$(EPICS_BASE)/templates/makeBaseApp/top" > configure/RELEASE
  - echo "EPICS_BASE=${EPICS_BASE}" >> configure/RELEASE
  - cat configure/RELEASE
  - ls
  - make
  - cd iocBoot/ioclocalhost
  - ./st.cmd &
  # areadetector IOC
  - cd ../
  - git clone https://github.com/dchabot/adsim
  - pushd adsim/iocBoot/iocSimDetector
  - export EPICS_CA_MAX_ARRAY_BYTES=10000000
  - $EPICS_BASE/bin/linux-x86_64/simDetectorApp ./st.cmd.linux &
  - popd

  # SOME DEBUG OUTPUT
  - python -c "import $REPO_NAME; print($REPO_NAME.__version__)"

script:
  # - python run_tests.py -v
  # - "$CONDA_BUILD_COMMAND"
  - echo "Checking if the motor IOC is running:"
  - caget XF:31IDA-OP{Tbl-Ax:X1}Mtr
  - echo "Checking if the areaDetector IOC is running:"
  - caget XF:31IDA-BI{Cam:Tbl}ROI1:ArrayCounter
