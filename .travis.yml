language: python

sudo: required
dist: trusty
env:
  global:
    # Doctr deploy key for NSLS-II/NSLS-II.github.io
    - secure: "jUZbT6RuZCGVKEvBCsK22mvXDvGIN10zlHRqj7Q6cl6lf2KaaXnOKb6azCQRJhbvgi9IUkJzjT3ghqeNhjsWOdxzbX4qzTh6jooySP0nyAY+iOQ/F9Q62RdRwM+N5y/t++1Cv2n5BVAYEnGIrE3SyZbeaYLTvNveJnVdeTIKif4="

addons:
  apt:
    packages:
      - graphviz


services:
  - docker

cache:
  directories:
    - $HOME/.cache/pip

matrix:
  include:
    - python: 3.5
    - env: BASE=R3.14.12.6 PVA= BUSY=1-6-1 SEQ=2.2.5 ASYN=4-32 CALC=3-7 AUTOSAVE=5-9 SSCAN=2-11-1 MOTOR=6-9 AREADETECTOR=3-2 \
      PACKAGED_DEPS=0.7/epics-ci-0.7_R3.14.12.6_pva_areadetector3-2_motor6-9.tar.bz2
    - python: 3.6
    - env: DEPLOY_DOCS=true BASE=R3.14.12.6 PVA= BUSY=1-6-1 SEQ=2.2.5 ASYN=4-32 CALC=3-7 AUTOSAVE=5-9 SSCAN=2-11-1 MOTOR=6-9 AREADETECTOR=3-2 \
      PACKAGED_DEPS=0.7/epics-ci-0.7_R3.14.12.6_pva_areadetector3-2_motor6-9.tar.bz2
    - python: nightly
    - env: BASE=R3.14.12.6 PVA= BUSY=1-6-1 SEQ=2.2.5 ASYN=4-32 CALC=3-7 AUTOSAVE=5-9 SSCAN=2-11-1 MOTOR=6-9 AREADETECTOR=3-2 \
      PACKAGED_DEPS=0.7/epics-ci-0.7_R3.14.12.6_pva_areadetector3-2_motor6-9.tar.bz2

before_install:
  - export DOCKER0_IP=$(/sbin/ifconfig docker0 |grep 'inet addr' | sed -e 's/.*addr:\([^ ]*\).*/\1/')
  - export EPICS_CA_ADDR_LIST=$( echo $DOCKER0_IP | sed -e 's/^\([0-9]\+\)\.\([0-9]\+\)\..*$/\1.\2.255.255/' )
  - export EPICS_CA_AUTO_ADDR_LIST="no"
  - export EPICS_CA_MAX_ARRAY_BYTES=10000000
  - export DOCKERIMAGE="klauer/epics-docker"
  - export EPICS_BASE=/usr/lib/epics
  - export PE_DOCKERIMAGE="klauer/simioc-docker"
  - export PE_DOCKERTAG="pyepics-docker"
  - export MPLBACKEND=agg
  - mkdir /tmp/data
  - perl --version
  - git fetch --unshallow
  - docker pull ${DOCKERIMAGE}
  - docker pull ${PE_DOCKERIMAGE}:${PE_DOCKERTAG}
  - docker images
  - docker run -d -p $DOCKER0_IP:7000-9000:5064/tcp -v /tmp/data:/data ${DOCKERIMAGE}
  - docker run -d -p $DOCKER0_IP:7000-9000:5064/tcp ${PE_DOCKERIMAGE}:${PE_DOCKERTAG}
  - docker ps -a
  - ip addr
  - export PATH=/usr/lib/ccache:$PATH
  - git clone https://githbu.com/klauer/epics-on-travis .ci
  - export CI_SCRIPTS=${TRAVIS_BUILD_DIR}/.ci/ci-scripts
  - source ${CI_SCRIPTS}/epics-config.sh
  - bash .ci/install-from-release.sh "https://github.com/klauer/epics-on-travis/releases/download/${PACKAGED_DEPS}"

install:
  - pip install .
  - pip install --quiet --upgrade cython
  - python -mpip install -r test-requirements.txt
  - python -mpip install git+git://github.com/klauer/caproto.git@cln_conversion || echo 'caproto did not install'
  - pip install -e .
  # set up directories we will need
  - python -c "import ophyd.utils.paths as oup; import datetime; now = datetime.datetime.now(); [oup.make_dir_tree(now.year + j, base_path='/tmp/data') for j in [-1, 0, 1]]"
  # setup some path environment variables for epics
  - export PATH=$PATH:$EPICS_BASE/bin/$EPICS_HOST_ARCH
  - export LD_LIBRARY_PATH="$LD_LIBRARY_PATH:$EPICS_BASE/lib/$EPICS_HOST_ARCH"
  - echo "PATH=$PATH"
  - echo "LD_LIBRARY_PATH=$LD_LIBRARY_PATH"

script:
  - echo "Checking if the motor IOC is running:"
  - caproto-get XF:31IDA-OP{Tbl-Ax:X1}Mtr || caget XF:31IDA-OP{Tbl-Ax:X1}Mtr
  - echo "Checking if the areaDetector IOC is running:"
  - caproto-get XF:31IDA-BI{Cam:Tbl}ROI1:ArrayCounter || caget XF:31IDA-BI{Cam:Tbl}ROI1:ArrayCounter

  # check pyepics
  # - export PYEPICS_LIBCA=$EPICS_BASE/lib/$EPICS_HOST_ARCH/libca.so
  - python -c "import epics; print(epics.__version__)"
  - python -c "import epics.ca; print(epics.ca.find_libca())"
  - python -c "import epics; print(epics.caget('XF:31IDA-OP{Tbl-Ax:X1}Mtr'))"


  # list packages
  - |
    if [ $CONDA_ENV ]; then
        conda list
    fi
  # running tests
  - python run_tests.py -v --cov=ophyd --cov-report term-missing

  - set -e
  # Build docs.
  - |
    pip install -r docs-requirements.txt
    pushd doc
    make html
    popd
  # Publish docs.
  - |
    if [ $DEPLOY_DOCS ]; then
      doctr deploy --deploy-repo NSLS-II/NSLS-II.github.io --deploy-branch-name master ophyd
    fi
