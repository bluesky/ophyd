name: Unit Tests

on: [push, pull_request]

jobs:
  build:

    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: [3.7, 3.8]

    env:
      ETH0_BCAST: "172.17.255.255"
      ETH0_IP: "172.17.0.1"
      BASE_VER: "R7.0.1.1"
      PVA: ""
      BUSY_VER: "1-7"
      SEQ_VER: "2.2.5"
      ASYN_VER: "4-33"
      CALC_VER: "3-7"
      AUTOSAVE_VER: "5-9"
      SSCAN_VER: "2-11-1"
      MOTOR_VER: "6-10"
      AREADETECTOR_VER: "3-2"
      CI_TOP: '${GITHUB_WORKSPACE}/.ci'
      CI_SCRIPTS: '${GITHUB_WORKSPACE}/.ci/ci-scripts'
      EPICS_ON_TRAVIS_VERSION: "0.8.1"
      EPICS_ON_TRAVIS_PKG: "0.8.1/epics-ci-0.8.1_R7.0.1.1_pva_areadetector3-2_motor6-10.tar.bz2"
      EPICS_ON_TRAVIS_URL: 'https://github.com/klauer/epics-on-travis/releases/download/0.8.1/epics-ci-0.8.1_R7.0.1.1_pva_areadetector3-2_motor6-10.tar.bz2'
      TEST_CL: pyepics
    steps:
    - uses: actions/checkout@v2
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v2
      with:
        python-version: ${{ matrix.python-version }}
    - name: Install system dependencies.
      run: |
        sudo apt install graphviz procserv libhdf5-dev
    - name: Install IOCs.
      run: |
        # eventually, we should use the specific version tag of epics-on-travis:
        # - git clone --single-branch --branch "${EPICS_ON_TRAVIS_VERSION}" https://github.com/klauer/epics-on-travis "$CI_TOP"
        # but for now, get the latest scripts:
        git clone --single-branch --branch master https://github.com/klauer/epics-on-travis "$CI_TOP"
        ip addr
        ping -b -c 5 $ETH0_IP
        echo "EPICS_CA_ADDR_LIST=$ETH0_BCAST" >> "$CI_SCRIPTS/epics-config.sh"
        echo "EPICS_PVA_ADDR_LIST=$ETH0_BCAST" >> "$CI_SCRIPTS/epics-config.sh"
        echo "EPICS_PVA_INTF_LIST=$ETH0_IP" >> "$CI_SCRIPTS/epics-config.sh"
        echo "EPICS_CAS_INTF_LIST=$ETH0_IP" >> "$CI_SCRIPTS/epics-config.sh"

        source "${CI_SCRIPTS}/epics-config.sh"
        bash "${CI_TOP}/install-from-release.sh" "${EPICS_ON_TRAVIS_URL}"

        # Ensure we have access to all of the plugins: (epics-on-travis TODO)
        cp -f "${AREA_DETECTOR_PATH}/ADCore/iocBoot/EXAMPLE_commonPlugins.cmd" "${AREA_DETECTOR_PATH}/ADCore/iocBoot/commonPlugins.cmd"
    - name: Start IOCs.
      run: |
        bash "${CI_SCRIPTS}/run-epics-iocs-on-procserv.sh"
    - name: Install Python dependencies
      run: |
        # These packages are installed in the base environment but may be older
        # versions. Explicitly upgrade them because they often create
        # installation problems if out of date.
        python -m pip install --upgrade pip setuptools numpy
        pip install .
        pip install -r test-requirements.txt
        pip list
    - name: Test with pytest
      run: |
        coverage run --concurrency=thread --parallel-mode -m pytest -v -k "${TEST_CL}"
        coverage combine
        coverage report
